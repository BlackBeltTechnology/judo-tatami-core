import "../namespace/namespace.etl";
import "../data/primitiveTypedElement.etl";
import "../data/referenceTypedElement.etl";
import "../derived/expressionType.etl";
import "../../../../operations/_importAll.eol";

@abstract
rule CreateTransferObjectRelation
    transform s: ESM!RelationFeature
    to t: JUDOPSM!TransferObjectRelation
    extends CreateNamedElement {
    
      t.target = s.target.getPSMTransferObjectTypeEquivalent();
      t.embedded = s.isAggregation();
      
      if (s.isCreateAllowed()) {
          t.embeddedCreate = true;
      }
      if (s.isUpdateAllowed()) {
          t.embeddedUpdate = true;
      }
      if (s.isDeleteAllowed()) {
          t.embeddedDelete = true;
      }
      t.cardinality = s.equivalent("CreateCardinalityForReferenceTypedElement");
      
//      t.get = s.equivalent("CreateGetOperationForTransferObjectRelation");
//      t.create = s.equivalent("CreateCreateOperationForTransferObjectRelation");
//      t.update = s.equivalent("CreateUpdateOperationForTransferObjectRelation");
//      t.`delete` = s.equivalent("CreateDeleteOperationForTransferObjectRelation");
      
      s.eContainer.getPSMEquivalent().relations.add(t);
}

@greedy
rule CreateRangeTransferObjectRelation
    transform s : ESM!RelationFeature
    to t : JUDOPSM!TransferObjectRelation {
        guard: s.eContainer.isKindOf(ESM!TransferObjectType) and s.eContainer.mapping.isDefined()
            and s.target.mapping.isDefined() and s.rangeExpression.isDefined() and s.rangeExpression.trim().length() > 0
            and s.memberType <> ESM!MemberType#DERIVED
            and not (s.memberType == ESM!MemberType#MAPPED and s.binding.memberType == ESM!MemberType#DERIVED)

        t.name = s.equivalent("CreateNavigationPropertyForTransferObjectRelationRange").name;
        t.cardinality = new JUDOPSM!Cardinality;
        t.cardinality.lower = 0;
        t.cardinality.upper = -1;
        t.target = s.target.getPSMTransferObjectTypeEquivalent();
        t.binding = s.equivalent("CreateNavigationPropertyForTransferObjectRelationRange");

        s.eContainer.getPSMTransferObjectTypeEquivalent().relations.add(t);
}

rule CreateTransferObjectRelationFromRelationOrProperty
    transform s: ESM!OneWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateTransferObjectRelation {
      guard: s.eContainer.isKindOf(ESM!TransferObjectType) 
            and not s.eContainer.isTypeOf(ESM!EntityType)
            and s.memberType <> ESM!MemberType#MAPPED

      t.defaultValue = s.equivalent("CreateStaticNavigationForTransferObjectRelationDefaultValue");

      if(s.eContainer.isMapped()) {
      	t.binding = s.equivalent("CreateNavigationPropertyForTransferObjectRelationBinding");
      	t.range = s.equivalent("CreateNavigationPropertyForTransferObjectRelationRange");
      } else {
      	t.binding = s.equivalent("CreateStaticNavigationForExposedGraph");
      }
        
      log.debug("Created TransferObjectRelation (from OneWayRelationMember): [" + t.name + "] into [" + t.eContainer.name + "]");
}

rule CreateTransferObjectRelationFromBoundToOneWayRelationMember
    transform s: ESM!OneWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateTransferObjectRelation {
      guard: s.memberType == ESM!MemberType#MAPPED
            and s.binding.isKindOf(ESM!OneWayRelationMember)

      if (s.binding.memberType = ESM!MemberType#STORED) {
        t.defaultValue = s.equivalent("CreateStaticNavigationForTransferObjectRelationDefaultValue");
        t.range = s.equivalent("CreateNavigationPropertyForTransferObjectRelationRange");
          if (s.binding.isComposition()) {
            t.binding = s.binding.equivalent("CreateContainment");
          } else {
            t.binding = s.binding.equivalent("CreateAssociationEndWithoutPartner");
          }
      } else if (s.binding.memberType = ESM!MemberType#DERIVED) {
        t.binding = s.binding.equivalent("CreateNavigationProperty");
      }
     
      log.debug("Created TransferObjectRelation (from OneWayRelationMember): [" + t.name + "] into [" + t.eContainer.name + "]");
}

rule CreateTransferObjectRelationFromBoundToTwoWayRelationMember
    transform s: ESM!OneWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateTransferObjectRelation {
      guard: s.memberType == ESM!MemberType#MAPPED
            and s.binding.isKindOf(ESM!TwoWayRelationMember)

        t.defaultValue = s.equivalent("CreateStaticNavigationForTransferObjectRelationDefaultValue");
        t.range = s.equivalent("CreateNavigationPropertyForTransferObjectRelationRange");
        t.binding = s.binding.equivalent("CreateAssociationEndWithPartner");

        log.debug("Created TransferObjectRelation (from OneWayRelationMember): [" + t.name + "] into [" + t.eContainer.name + "]");
}

@lazy
@greedy
rule CreateCardinalityOfTransferObjectRelationForDefaultTransferObjectType
    transform s: ESM!ReferenceTypedElement
    to t: JUDOPSM!Cardinality {
      t.upper = s.upper;
      t.lower = s.lower;
}

@abstract
rule CreateTransferObjectRelationForDefaultTransferObjectType
    transform s: ESM!ReferenceTypedElement
    to t: JUDOPSM!TransferObjectRelation
    extends CreateNamedElement {
      t.cardinality = s.equivalent("CreateCardinalityOfTransferObjectRelationForDefaultTransferObjectType");
      t.target = s.target.equivalent("CreateDefaultMappedTransferObjectTypeForEntity");
      s.eContainer.equivalent("CreateDefaultMappedTransferObjectTypeForEntity").relations.add(t);
      t.embedded = s.isAggregation();
      
      if (s.isCreateAllowed()) {
          t.embeddedCreate = true;
      }
      if (s.isUpdateAllowed()) {
          t.embeddedUpdate = true;
      }
      if (s.isDeleteAllowed()) {
          t.embeddedDelete = true;
      }

//      t.get = s.equivalent("CreateGetOperationForTransferObjectRelation");
//      t.create = s.equivalent("CreateCreateOperationForTransferObjectRelation");
//      t.update = s.equivalent("CreateUpdateOperationForTransferObjectRelation");
//      t.`delete` = s.equivalent("CreateDeleteOperationForTransferObjectRelation");
      
      log.debug("Created TransferObjectRelation for DefaultTransferObjectType: [" + t.name + "] into [" + t.eContainer.name + "]");
}

rule CreateTransferObjectRelationForDefaultTransferObjectTypeFromOneWayRelationMemberContainment
    transform s: ESM!OneWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateTransferObjectRelationForDefaultTransferObjectType {
      guard: s.memberType == ESM!MemberType#STORED
           and s.isComposition()

      t.defaultValue = s.equivalent("CreateStaticNavigationForTransferObjectRelationDefaultValue");
      t.range = s.equivalent("CreateNavigationPropertyForTransferObjectRelationRange");
      t.embedded = s.isComposition();
      t.binding = s.equivalent("CreateContainment");
      
      log.debug("Created TransferObjectRelation for DefaultTransferObjectType: [" + t.name + "] into [" + t.eContainer.name + "]");
}

rule CreateTransferObjectRelationForDefaultTransferObjectTypeFromOneWayRelationMemberNotContainment
    transform s: ESM!OneWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateTransferObjectRelationForDefaultTransferObjectType {
      guard: s.memberType == ESM!MemberType#STORED
           and not s.isComposition()

      t.defaultValue = s.equivalent("CreateStaticNavigationForTransferObjectRelationDefaultValue");
      t.range = s.equivalent("CreateNavigationPropertyForTransferObjectRelationRange");
      t.binding = s.equivalent("CreateAssociationEndWithoutPartner");

      log.debug("Created TransferObjectRelation for DefaultTransferObjectType: [" + t.name + "] into [" + t.eContainer.name + "]");
}

rule CreateTransferObjectRelationForDefaultTransferObjectTypeFromOneWayRelationMemberProperty
    transform s: ESM!OneWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateTransferObjectRelationForDefaultTransferObjectType {
      guard: s.eContainer.isKindOf(ESM!EntityType)
           and s.memberType == ESM!MemberType#DERIVED
           
      t.binding = s.equivalent("CreateNavigationProperty");
      
      log.debug("Created TransferObjectRelationFromTwoWayRelationMember: [" + t.name + "] into [" + t.eContainer.name + "]");
}

rule CreateTransferObjectRelationForDefaultTransferObjectTypeFromTwoWayRelationMember
    transform s: ESM!TwoWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateTransferObjectRelationForDefaultTransferObjectType {

      t.defaultValue = s.equivalent("CreateStaticNavigationForTransferObjectRelationDefaultValue");
      t.range = s.equivalent("CreateNavigationPropertyForTransferObjectRelationRange");
      t.binding = s.equivalent("CreateAssociationEndWithPartner");
      
      log.debug("Created TransferObjectRelationFromTwoWayRelationMember: [" + t.name + "] into [" + t.eContainer.name + "]");
}

@lazy
@greedy
rule CreateCardinalityForOptionalReferenceTypedElement
    transform s: ESM!ReferenceTypedElement
    to t: JUDOPSM!Cardinality {
      t.upper = s.upper;
      t.lower = 0;
}

@abstract
rule CreateOptionalTransferObjectRelation
    transform s: ESM!RelationFeature
    to t: JUDOPSM!TransferObjectRelation
    extends CreateNamedElement {

      t.target = s.target.getPSMOptionalEquivalent();
      t.embedded = s.isAggregation();
      
      if (s.isCreateAllowed()) {
          t.embeddedCreate = true;
      }
      if (s.isUpdateAllowed()) {
          t.embeddedUpdate = true;
      }
      if (s.isDeleteAllowed()) {
          t.embeddedDelete = true;
      }
      
      t.cardinality = s.equivalent("CreateCardinalityForOptionalReferenceTypedElement");
      s.eContainer.getPSMOptionalEquivalent().relations.add(t);
}

rule CreateOptionalTransferObjectRelationFromRelationOrProperty
    transform s: ESM!OneWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateOptionalTransferObjectRelation {
      guard: s.memberType == ESM!MemberType#TRANSIENT

      if(s.eContainer.isMapped()) {
        t.binding = s.equivalent("CreateNavigationPropertyForTransferObjectRelationBinding");
      } else {
        t.binding = s.equivalent("CreateStaticNavigationForExposedGraph");
      }
        
      log.debug("Created Optional TransferObjectRelation (from OneWayRelationMember): [" + t.name + "] into [" + t.eContainer.name + "]");
}

rule CreateOptionalTransferObjectRelationFromBoundToOneWayRelationMember
    transform s: ESM!OneWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateOptionalTransferObjectRelation {
      guard: s.eContainer.isKindOf(ESM!TransferObjectType) 
            and not s.eContainer.isTypeOf(ESM!EntityType)
            and s.memberType == ESM!MemberType#MAPPED
            and s.binding.isKindOf(ESM!OneWayRelationMember)
            and s.binding.memberType == ESM!MemberType#STORED
            
      if (s.binding.isComposition()) {
        t.binding = s.binding.equivalent("CreateOptionalContainment");
      } else if (not s.binding.isComposition()) {
        t.binding = s.binding.equivalent("CreateOptionalAssociationEndWithoutPartner");
      } 
      
      log.debug("Created Optional TransferObjectRelation (from OneWayRelationMember): [" + t.name + "] into [" + t.eContainer.name + "]");
}

rule CreateOptionalTransferObjectRelationFromBoundToTwoWayRelationMember
    transform s: ESM!OneWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateOptionalTransferObjectRelation {
      guard: s.eContainer.isKindOf(ESM!TransferObjectType) 
            and not s.eContainer.isTypeOf(ESM!EntityType)
            and s.memberType == ESM!MemberType#MAPPED
            and s.binding.isKindOf(ESM!TwoWayRelationMember)
            
      t.binding = s.binding.equivalent("CreateOptionalAssociationEndWithPartner");

      log.debug("Created Optional TransferObjectRelation (from OneWayRelationMember): [" + t.name + "] into [" + t.eContainer.name + "]");
}

rule CreateOptionalTransferObjectRelationForOptionalEntityTypeFromContainment
    transform s: ESM!OneWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateOptionalTransferObjectRelation {
      guard: s.memberType == ESM!MemberType#STORED
      
      t.binding = s.equivalent("CreateContainment");
      t.embedded = s.isComposition();
      
      log.debug("Created Optional TransferObjectRelation for Optional TransferObjectType: [" + t.name + "] into [" + t.eContainer.name + "]");
}

rule CreateOptionalTransferObjectRelationForForOptionalEntityTypeFromTwoWayRelationMember
    transform s: ESM!TwoWayRelationMember
    to t: JUDOPSM!TransferObjectRelation
    extends CreateOptionalTransferObjectRelation {
      
      t.binding = s.equivalent("CreateAssociationEndWithPartner");
      
      log.debug("Created Optional TransferObjectRelation From TwoWayRelationMember: [" + t.name + "] into [" + t.eContainer.name + "]");
}

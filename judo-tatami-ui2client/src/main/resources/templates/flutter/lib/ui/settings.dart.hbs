{{ log 'Settings page generation for' (variable application.name) level='info' }}
//////////////////////////////////////////////////////////////////////////////
// G E N E R A T E D    C L A S S
// ------------------------------
// Factory expression: {{{ cleanup template.factoryExpression }}}
// Path expression: {{{ cleanup template.pathExpression }}}
// Overwrite: {{{ cleanup template.overwriteExpression }}}
// Template name: {{ template.templateName }}
// Application: {{ application.name }}

import 'package:flutter/material.dart';
import 'package:flutter_mobx/flutter_mobx.dart';
import 'package:mobx/mobx.dart';
import 'package:judo_flutter_components/judo_flutter_components.dart';
import 'package:flutter/scheduler.dart';

import 'package:{{ modelPackage application.name }}/{{ path application.name }}/auth/auth.dart';
import 'package:{{ modelPackage application.name }}/{{ path application.name }}/injector/injector.dart';
import 'package:{{ modelPackage application.name }}/{{ path application.name }}/ui/scaffold.dart';
import 'package:{{ modelPackage application.name }}/{{ path application.name }}/ui/navigation/navigation_state.dart';
import 'package:{{ modelPackage application.name }}/{{ path application.name }}/utilities/package.dart';
import 'package:{{ modelPackage application.name }}/{{ path application.name }}/l10n/app_localizations.dart';
import 'package:openapi_dart_common/openapi.dart';
import 'package:shared_preferences/shared_preferences.dart';

part 'settings.g.dart';

class {{ fqClass application.name }}SettingsPageStore extends _{{ fqClass application.name }}SettingsPageStore
with _${{ fqClass application.name }}SettingsPageStore {}

abstract class _{{ fqClass application.name }}SettingsPageStore with Store {
    @observable
    String apiUrl = API_DEFAULT_BASE_URL;

    @observable
    bool loading = true;

    @action
    Future<void> loadApiUrl() async {
        SharedPreferences sharedPreferences = await SharedPreferences.getInstance();
        this.apiUrl = sharedPreferences.getString("apiUrl") ?? apiUrl;
        loadFinished();
    }

    @action
    void setApiUrl(String apiUrl) {
    this.apiUrl = apiUrl;
    }

    @action
    void loadFinished() {
    loading = false;
    }
}

class {{ fqClass application.name }}SettingsPage extends StatefulWidget {
    static const String title = 'Settings';

    @override
    _{{ fqClass application.name }}SettingsPageState createState() => _{{ fqClass application.name }}SettingsPageState();
}

class _{{ fqClass application.name }}SettingsPageState extends State<{{ fqClass application.name }}SettingsPage> {

    final {{ fqClass application.name }}SettingsPageStore store = {{ fqClass application.name }}SettingsPageStore();

    _{{ fqClass application.name }}SettingsPageState()  {
        final navigation = locator<NavigationState>();
        SchedulerBinding.instance.addPostFrameCallback((_) {
            navigation.setCurrentTitle(AppLocalizations.of(context).lookUpValue(context, {{ fqClass application.name }}SettingsPage.title));
        });
        store.loadApiUrl();
    }

    @override
    Widget build(BuildContext context) {
        final navigation = locator<NavigationState>();

        return Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                            Row(
                                children: [
                                    JudoButton(
                                        col: 1,
                                        onPressed: () => navigation.close(),
                                        label: 'Back',
                                        icon: Icon(Icons.arrow_back_ios),
                                    ),
                                    JudoButton(
                                        col: 1,
                                        onPressed: () async {
                                            SharedPreferences prefs = await SharedPreferences.getInstance();
                                            await prefs.setString('apiUrl', store.apiUrl);
                                            var auth = locator<Auth>();

                                            ApiClient _apiClient = ApiClient(basePath: store.apiUrl + API_RELATIVE_PATH, apiClientDelegate: auth.getDioDelegate());
                                            locator.unregister(instance: locator<ApiClient>());
                                            locator.registerSingleton<ApiClient>(_apiClient);
                                            navigation.close();
                                        },
                                        label: 'Save',
                                        icon: Icon(Icons.save),
                                    ),
                        ],
                    ),
                    Row(
                        mainAxisAlignment: MainAxisAlignment.start,
                        children: [
                            Observer(builder: (_) =>
                                store.loading ?
                                JudoLoadingProgress() :
                                JudoInputText(
                                    col: 4,
                                    icon: Icon(Icons.web),
                                    label: 'API url',
                                    initialValue: store.apiUrl.toString(),
                                    onChanged: (value) => store.setApiUrl(value),
                                ),
                            ),
                        ],
                    ),
                ],
        );
    }
}

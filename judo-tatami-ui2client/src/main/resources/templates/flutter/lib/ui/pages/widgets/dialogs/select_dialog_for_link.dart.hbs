{{log 'Dialog generation for' (variable application.name) '-' (fqClass page.name) level='info'}}
//////////////////////////////////////////////////////////////////////////////
// G E N E R A T E D    C L A S S
// ------------------------------
// Factory expression: {{{ cleanup template.factoryExpression }}}
// Path expression: {{{ cleanup template.pathExpression }}}
// Overwrite: {{{ cleanup template.overwriteExpression }}}
// Template name: {{ template.templateName }}
// Application: {{ application.name }}
// Page: {{ page.name }}
// Table: {{ table.name }}

part of {{ variable application.name }}.ui.pages.dialogs;

{{# with table.parts as |tableColumns| }}
{{# with table.dataElement as |relation|}}
Future<{{# if relation.isCollection }}List<{{ fqClass relation.target.name }}Store>{{ else }}{{ fqClass relation.target.name }}Store{{/ if }}> judoSelect{{ fqClass relation.name }}{{ className relation.target.name }}DialogFor{{fqClass page.name}}Page({@required BuildContext context, {{fqClass page.name}}PageStore pageStore,{{# unless (isAccessTablePage page) }} {{ fqClass relation.owner.name }}Store ownerStore{{/ unless }} }) async {
{{# if relation.isRelationBehaviourTypeRangeable }}
{{# unless (isAccessTablePage page) }}
    var addFilterButtonKey = GlobalKey();
    int tableQueryLimit = ({{ table.row }}-1).round();
    pageStore.getRangeFor{{ fqClass relation.name }}(ownerStore, queryLimit: tableQueryLimit).catchError((error) => ErrorHandler.errorDialog(context, error));

    Map<String, FilterStore> stringFilterStoreMap = {
    {{# each tableColumns as |column|}}
        {{# if column.attributeType.isFilterable}}
            {{# each column.attributeType.dataType.operator.members as |filterOperator|}}
        '{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter' : FilterStore(label: '{{ className column.attributeType.name }} {{ className filterOperator.name }}', filterOperation: '{{ variable filterOperator.name }}', attributeName: '{{ className column.attributeType.name }}'),
            {{/each}}
        {{/ if }}
    {{/ each }}
    };

    Map<FilterStore, Widget> filterStoreWidgetMap = {
    {{# each tableColumns as |column|}}
        {{# if column.attributeType.isFilterable}}
            {{# each column.attributeType.dataType.operator.members as |filterOperator|}}
        stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'] :
                {{# if (isStringType column.attributeType.dataType) }}
            JudoInputText(
                col: 1,
                label: stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].label,
                onChanged: (value) => stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].setFilterValue(value),
            ),
                {{/ if }}
                {{~# if (isNumericType column.attributeType.dataType) }}
            JudoNumericInput(
                col: 1,
                label: stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].label,
                onChanged: (value) => stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].setFilterValue({{ dartType column.attributeType.dataType }}.parse(value)),
            ),
                {{/ if }}
                {{~# if (isDateType column.attributeType.dataType) }}
            JudoDateInput(
                col: 1,
                label: stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].label,
                onChanged: (value) => stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].setFilterValue(value),
            ),
                {{/ if }}
                {{~# if (isTimestampType column.attributeType.dataType) }}
            JudoDateTimeInput(
                col: 1,
                label: stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].label,
                onChanged: (value) => stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].setFilterValue(value),
            ),
                {{/ if }}
                {{~# if (isBooleanType column.attributeType.dataType) }}
            Observer(
                builder: (_) => JudoSwitch(
                    col: 1,
                    label: stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].label,
                    initialValue: stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].filterValue,
                    onChanged: (value) => stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].setFilterValue(value),
                )
            ),
                {{/ if }}
                {{~# if (isEnumType column.attributeType.dataType) }}
            Observer(
                builder: (_) => JudoComboBox<{{ className column.attributeType.dataType.name }}>(
                    col: 1,
                    label: stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].label,
                    onChanged: (value) => stringFilterStoreMap['{{ variable column.attributeType.name }}{{ className filterOperator.name }}Filter'].setFilterValue(value),
                    items: {{ className attributeType.dataType.name }}.values,
                    dropdownMenuShow: (value) => new DropdownMenuItem<{{ className attributeType.dataType.name }}>(
                        value: value,
                        child: new Text(value.toString().split('.').last)
                    ),
                )
            ),
                {{/ if }}
            {{/each}}
        {{/ if }}
    {{/ each }}
    };

    ObservableList<String> selected = <String>[].asObservable();
    var tableHelperStore = TableHelperStore(selected, ({{ fqClass relation.target.name }}Store value) => value.internal__identifier);

  return await showDialog<{{# if relation.isCollection }}List<{{ fqClass relation.target.name }}Store>{{ else }}{{ fqClass relation.target.name }}Store{{/ if }}>(
    context: context,
    builder: (context) {
      return AlertDialog(
          content: GestureDetector(
            onTap: () => FocusScope.of(context).requestFocus(new FocusNode()),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Column(
                  children: getInputFilterWidgets(filterStoreWidgetMap),
                ),
                Row(
                  children: [
                    JudoButton(
                        key: addFilterButtonKey,
                        col: 1,
                        alignment: Alignment.center,
                        icon: Icon(Icons.add),
                        label: 'Add filter',
                        onPressed: () async {
                            FilterStore selectedAttribute = await judoShowMenu(
                                buttonKey: addFilterButtonKey,
                                items: getPopupMenuAttributeItems(stringFilterStoreMap.values.toList()),
                                context: context,
                            );
                            if (selectedAttribute != null) {
                                FilterStore result = await judoShowMenu(
                                    buttonKey: addFilterButtonKey,
                                    items: getPopupMenuOperationItemsByAttribute(stringFilterStoreMap.values.toList(), selectedAttribute),
                                    context: context,
                                );
                                if (result != null) {
                                    result.changeFilterEnabled();
                                }
                            }
                        },
                    ),
                    JudoButton(
                        col: 1,
                        alignment: Alignment.center,
                        icon: Icon(Icons.search),
                        label: 'Search',
                        onPressed: () async {
                            pageStore.getRangeFor{{ fqClass relation.name }}(
                                ownerStore,
                                queryLimit: tableQueryLimit,
                                filterStoreList: stringFilterStoreMap.values.where((element) => element.filterEnabled).toList(),
                            ).catchError((error) => ErrorHandler.errorDialog(context, error));
                        },
                    ),
                  ],
                ),
                Row(
                  children: [
                    // ignore: missing_return
                    Observer(builder: (_) {
                      switch(pageStore.{{ fqVariable relation.name }}StoreFuture.status){
                        case FutureStatus.pending:
                          return JudoLoadingProgress();
                        case FutureStatus.rejected:
                          return Container();
                        case FutureStatus.fulfilled:
                          var dataInfo = {{ fqClass table.pageDefinition.name }}{{ fqClass table.name }}DialogTable(disabled: false);
                          return JudoSelectorTable(
                            disabled: false,
                            collectionSelector: {{ relation.isCollection}},
                            col: 1,
                            row: {{ table.row }} >= 6 ? {{ table.row }} : 6,
                            dataInfo: dataInfo,
                            sortAscending: pageStore.{{ fqVariable relation.name }}SortAsc,
                            sortColumnIndex: pageStore.{{ fqVariable relation.name }}SortColumnIndex,
                            onSort: (int columnIndex, bool asc) {
                                pageStore.{{ fqVariable relation.name }}SetSortRange(
                                  ownerStore,
                                  context,
                                  dataInfo.getColumnFieldByIndex(columnIndex, asc),
                                  columnIndex,
                                  asc,
                                  dataInfo.getSortComparator(columnIndex, asc),
                                  filterStoreList: stringFilterStoreMap.values.where((element) => element.filterEnabled).toList(),
                              );
                            },
                            rowList: pageStore.{{ fqVariable relation.name }}StoreRangeList,
                            multiSelectAction: ({{ fqClass relation.target.name }}Store element) => tableHelperStore.selectRow(element),
                            singleSelectAction: ({{ fqClass relation.target.name }}Store element) => tableHelperStore.singleSelectRow(element),
                            multiSelectedComparator: ({{ fqClass relation.target.name }}Store element) => tableHelperStore.selected.contains(tableHelperStore.getId(element)),
                            singleSelectedComparator: ({{ fqClass relation.target.name }}Store element) => tableHelperStore.singleSelected == tableHelperStore.getId(element),
                          );
                      }
                    }),
                  ],
                ),
                Row(
                    children: [
                        Padding(
                            padding: JudoComponentCustomizer.get().getDefaultPadding(),
                            child: Observer(
                                builder: (_) => Text(
                                    'Showed ${pageStore.{{ fqVariable relation.name }}StoreRangeList.length} rows.',
                                    style: TextStyle(
                                        fontSize: 12,
                                        color: Colors.black54
                                    ),
                                ),
                            ),
                        ),
                    ],
                )
              ],
            ),
          ),
        actions: [
          Padding(
            padding: const EdgeInsets.all(10.0),
            child: Observer(
              builder: (_) => ElevatedButton(
                child: Text('Select'),
                onPressed: tableHelperStore.selectButtonEnabled ? () {
                  var resultList = pageStore.{{ fqVariable relation.name }}StoreRangeList
                        .where((element) => selected.contains(element.internal__identifier))
                        .toList();
                  Navigator.of(context).pop(resultList);
                } : null,
              ),
            ),
          ),
        ],
      );
    },
  );
{{/ unless}}
{{/ if }}
}
{{/ with }}
{{/with}}
